
---

## Redis 有哪 2 种持久化方式？各自的优缺点是什么？
Redis 的读写操作都是在 **内存中** 进行的，因此 Redis 速度快，但如果 **Redis 进程崩溃或重启**，所有 **内存数据都会丢失**。为了 **保证数据不丢失**，Redis 提供了 **持久化机制**，即将数据存储到 **磁盘**，以便在重启后恢复。
Redis 有两种主要的持久化方式：
- **AOF（Append-Only File）日志**：每执行一条 **写操作命令**，都会将该命令 **追加写入** AOF 日志文件。
- **RDB（Redis Database）快照**：将 **某一时刻的内存数据** 以 **二进制快照** 方式保存到磁盘。


---


### AOF 日志如何实现？
Redis 在执行 **每条写操作** 之后，会 **追加命令到 AOF 文件**，然后 **Redis 重启时**，会 **读取 AOF 文件中的命令并逐条执行**，从而恢复数据。

![[AOF_workflow.webp]]

Redis 提供了 **3 种回写磁盘的策略**，可在 `redis.conf` 配置文件中 **配置** `**appendfsync**` **参数**：
- `always`（总是）：每次写操作执行后，立即将 AOF 数据写入磁盘，数据最安全，但性能较差。
- `everysec`（默认）：每次写操作后，先写入 AOF 文件的 **内核缓冲区**，然后 **每秒同步写入磁盘**，性能与安全性的折中方案。
- `no`：Redis **不主动控制写入磁盘**，由 **操作系统决定** 何时将缓冲区数据写入磁盘，性能最佳，但可能会丢失较多数据。

![[AOF_writeback.webp]]


---

## RDB 快照如何实现？

由于 **AOF 记录的是操作命令**，而不是数据本身，因此使用 AOF 进行数据恢复时，**需要重新执行所有 AOF 记录的命令**，如果 **AOF 文件过大**，恢复速度会非常慢。

为了解决这个问题，Redis 提供了 **RDB 快照** 持久化。

RDB 快照是 **记录某一时刻的内存数据快照**，类似于拍照，记录的是真实数据，而 AOF 记录的只是操作命令。因此，在 **恢复数据时，RDB 的效率要比 AOF 高**，因为可以直接读取 RDB 文件恢复，而 **不需要逐条执行命令**。

Redis 提供了 **两个命令** 来手动生成 RDB 文件：
- `save`：在 **主线程** 中生成 RDB 文件，会阻塞主线程，影响性能。
- `bgsave`：创建 **子进程** 生成 RDB 文件，避免阻塞主线程。


---


## AOF 和 RDB 的优缺点

### AOF：
- **优点**：
    - 提供更好的 **数据安全性**，默认 **每条写命令都会追加到日志**，即使 Redis 崩溃也能恢复最近的数据。
    - 支持 **多种同步策略**（`always`、`everysec` 等），可以平衡数据安全性和性能。
    - 通过 **重写机制** 减少日志体积，提高恢复速度。
    - 提供 `**redis-check-aof**` 工具，修复损坏的 AOF 文件。
- **缺点**：
    - **AOF 文件通常比 RDB 大**，占用更多磁盘空间。
    - 频繁磁盘 I/O 可能影响 Redis 性能，特别是 `always` 模式。
    - **恢复速度较慢**，需要逐条执行日志中的操作命令。

### RDB：
- **优点**：
    - **文件体积小**，存储的是数据快照，而不是所有操作命令。
    - **恢复速度快**，直接加载快照，不需要重放日志。
    - **不会频繁 I/O**，Redis 通过 **子进程** 生成快照，不影响主线程性能。
- **缺点**：
    - **可能丢失最后一次快照后发生的数据**，默认配置下 RDB 可能每 5 分钟才生成一次。
    - **生成快照期间可能导致 CPU 和磁盘 I/O 负载增加**。