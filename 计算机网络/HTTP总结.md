# HTTP 协议学习总结

## 1. HTTP/1.0
- **连接模式**：默认短连接，请求完成后直接关闭 TCP 连接。
- **请求结束方式**：通过客户端关闭连接（EOF）来判断结束。
- **特点**：
  - 每个请求都要新建 TCP 连接（三次握手+慢启动），性能较差。
  - 无法并行处理请求。

---

## 2. HTTP/1.1
- **连接模式**：引入 `Connection: keep-alive`，默认长连接。
- **请求结束方式**：
  - **Content-Length**：明确声明请求体的字节数。
  - **Transfer-Encoding: chunked**：分块传输，靠 0 长度块标记结束。
- **改进点**：
  - 避免频繁建连，性能提升。
  - 支持管线化 (pipelining)，允许连续发送多个请求。
- **问题**：
  - 响应必须按顺序返回，存在 **队头阻塞**。
  - 管线化很少在实际应用中使用。
- **典型限制**：服务器通常限制头部大小（如 8KB），过大报 431 错误。

---

## 3. HTTP/2
### 3.1 二进制帧机制
- 报文被拆分为更小的 **二进制帧 (frame)**。
- **帧结构**：9字节帧头 + 载荷。
  - **HEADERS 帧**：承载请求行与头部字段（使用 HPACK 压缩）。
  - **DATA 帧**：承载请求体或响应体，保持原始字节（JSON、HTML、PNG 等）。
  - 其他帧：SETTINGS、PING、RST_STREAM 等。
- **优势**：为无边界的 TCP 流增加结构化边界，便于交错传输和重组。

### 3.2 HPACK 头部压缩
- **问题**：HTTP/1.1 中头部冗余，重复传输消耗带宽。
- **解决**：
  - **静态表**：常见头部有固定索引（如 `:method = GET` → 索引 2）。
  - **动态表**：双方维护共享表，已传过的字段下次只需发索引。
  - **Huffman 编码**：进一步压缩字符串。
- **效果**：减少重复传输，提高效率。

### 3.3 应用层多路复用
- 每个请求/响应被划分为一个 **流 (stream)**，通过 **Stream ID** 标识。
- 不同流的帧可以交错传输：
  ```
  [HEADERS Stream 1] [HEADERS Stream 3] [DATA Stream 1] [DATA Stream 3] ...
  ```
- 服务端根据 Stream ID 拼接数据，互不干扰。
- **优点**：
  - 一个 TCP 连接并行多个请求。
  - 消除了 HTTP/1.1 的应用层队头阻塞。

---

## 4. 应用层多路复用 vs OS 层多路复用
- **OS 层多路复用**：通过 epoll/select/poll，一个线程监听多个 TCP 连接。
- **HTTP/2 多路复用**：在一条 TCP 连接里，用 Stream ID 承载多个并行请求。

---

## 5. HTTP/1.x 与 HTTP/2 对比表

| 特性            | HTTP/1.0          | HTTP/1.1                          | HTTP/2                                 |
|-----------------|------------------|-----------------------------------|----------------------------------------|
| 连接模式        | 短连接            | 长连接 (keep-alive)                 | 长连接，多路复用                         |
| 请求结束方式    | 关闭连接          | Content-Length / chunked           | END_STREAM 标志 (帧级别)                 |
| 报文格式        | 文本 (请求行+头+体) | 文本 (请求行+头+体)                 | 二进制帧 (HEADERS + DATA + Stream ID)   |
| 并发能力        | 无                | 有限 (pipelining，但仍有阻塞)         | 真正并发，多请求交错                       |
| 队头阻塞        | 严重              | 严重                               | 应用层解决（但 TCP 层仍可能有队头阻塞）     |
| 头部压缩        | 无                | 无                                 | HPACK 压缩（静态表+动态表+Huffman）       |

---

## 6. 总结
1. **HTTP/1.0**：短连接，性能差，靠关闭连接判断请求结束。  
2. **HTTP/1.1**：长连接，支持 Content-Length 与 chunked，仍受队头阻塞限制。  
3. **HTTP/2**：引入二进制帧机制、HPACK 压缩、应用层多路复用，极大提升性能。  
