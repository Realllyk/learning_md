## 执行一条SQL请求的过程是什么
先来看一个上帝视角图，下面是 MySQL 执行一条 SQL 查询语句的流程，也从图中可以看到 MySQL 内部架构里的各个功能模块。

![[sql_engine_order.webp]]

### **1. 连接器**
- **建立连接**：管理连接，校验用户身份。

### **2. 查询缓存**（MySQL 8.0 已删除）
- **查询缓存**：如果命中查询缓存，则直接返回结果；否则继续往下执行。

### **3. 解析 SQL**
- **解析器**：通过解析器对 SQL 语句进行**词法分析**、**语法分析**，然后构建语法树，以便后续模块读取表名、字段、语句类型等信息。

### **4. 执行 SQL**
执行 SQL 语句主要有 **三个阶段**：

1. **预处理阶段**：
   - 检查表或字段是否存在；
   - 将 `SELECT *` 中的 `*` 符号展开为表上的所有列。

2. **优化阶段**：
   - **查询成本分析**：基于查询成本的考量，选择查询成本最小的执行计划。

3. **执行阶段**：
   - 根据优化计划执行 SQL 语句；
   - **从存储引擎获取记录**，返回结果给客户端。


---


## 讲一讲 MySQL 的引擎吧，你有什么了解？

### **1. InnoDB**
- **MySQL 的默认存储引擎**，具备 **ACID 事务支持**、**行级锁**、**外键约束**等特性。
- 适用于 **高并发的读写操作**，支持良好的 **数据完整性** 和 **并发控制**。

### **2. MyISAM**
- **MySQL 另一种常见的存储引擎**，具备 **较低的存储空间和内存消耗**，适用于 **大量读操作** 的场景。
- **不支持事务**，**不支持行级锁和外键约束**，因此在 **并发写入和数据完整性** 方面存在一定限制。

### **3. Memory**
- **数据存储在内存中**，适用于 **对性能要求较高的读操作**。
- **缺点**：服务器重启或崩溃时，**数据会丢失**。
- **不支持事务、行级锁和外键约束**。


---

## MySQL 为什么 InnoDB 是默认引擎？

InnoDB 引擎在 **事务支持**、**并发性能**、**崩溃恢复** 等方面具有优势，因此被 MySQL 选择为默认的存储引擎。

### **InnoDB 作为默认引擎的优势：**
- **事务支持**：InnoDB 提供了对事务的支持，可以进行 **ACID**（**原子性、一致性、隔离性、持久性**）操作，而 MyISAM 存储引擎 **不支持事务**。
- **并发性能**：InnoDB 引擎采用了 **行级锁** 机制，能够提供更好的 **并发性能**。MyISAM 仅支持表级锁，**锁的粒度较大**，并发性能较差。
- **崩溃恢复**：InnoDB 通过 **redo log** 日志实现 **崩溃恢复**，可以在数据库发生异常情况（如断电）时，通过日志文件进行恢复，确保 **数据的持久性和一致性**。MyISAM **不支持崩溃恢复**。

---

## 说一下 MySQL 的 InnoDB 与 MyISAM 的区别？

### **1. 事务**
- **InnoDB** 支持 **事务**，而 **MyISAM** 不支持事务。
- 由于事务的重要性，MySQL **默认存储引擎** 由 MyISAM **变成** InnoDB。

### **2. 索引结构**
- **InnoDB** 使用 **聚簇索引（Clustered Index）**，主键索引存放数据的叶子节点，查询主键时必须扫描索引，效率较高，但查询其他索引时需要 **两次索引查找**。
- **MyISAM** 使用 **非聚簇索引（Non-Clustered Index）**，数据和索引是分离存储的，**主键和辅助索引是独立的**。

### **3. 锁粒度**
- **InnoDB** 采用 **行级锁**，并发性能更优。
- **MyISAM** 仅支持 **表级锁**，一个查询需要锁定整个表，可能导致更新和查询的互斥，**影响并发访问**。

### **4. `COUNT(*)` 的效率**
- **InnoDB** **不存储表的行数**，`SELECT COUNT(*)` 需要 **全表扫描**，查询速度较慢。
- **MyISAM** 维护一个 **计数变量** 存储表的总行数，`COUNT(*)` 直接读取该变量，**查询速度更快**。


---


# 数据管理里：数据文件大体分成哪几种数据文件？

我们每创建一个 **database（数据库）** 都会在 `/var/lib/mysql/` 目录里面创建一个以 database 为名的目录，然后保存表结构和表数据的文件都会存放在这个目录里。

例如，我创建了一个名为 `my_test` 的 database，该 database 里有一张名为 `t_order` 的数据库表。

![[test_db_struct.webp]]

然后，我们进入 `/var/lib/mysql/my_test` 目录，看看里面有什么文件？

``` shell
[root@xiaolin ~]# ls /var/lib/mysql/my_test
db.opt
t_order.frm
t_order.ibd
```


可以看到，共有三个文件，这三个文件分别代表着：

- **`db.opt`**
    - 用于存储当前数据库的默认字符集和字符校验规则。
- **`t_order.frm`**
    - `t_order` 的表结构会保存在这个文件。
    - 在 MySQL 中建立一张表都会生成一个 `.frm` 文件，该文件主要用于保存 **表结构信息**，包含表的元数据定义。
- **`t_order.ibd`**
    - `t_order` 的表数据会保存在这个文件中。
    - 表数据既可以存放在 **共享表空间文件**（文件名：`ibdata1`）里，也可以存放在 **独立表空间文件**（文件名：`表名.ibd`）里。
    - 这个行为由参数 `innodb_file_per_table` 控制：
        - **值为 1**（默认）：表数据（存储的数据、索引等）存储在 **独立 `.ibd` 文件** 中。
        - **值为 0**：表数据存储在 **共享表空间 `ibdata1` 文件** 里。