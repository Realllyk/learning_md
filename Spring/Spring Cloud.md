
## 一致性哈希（Consistent Hashing）介绍

### 一、什么是一致性哈希？

一致性哈希是一种用于分布式系统的数据分布算法，其核心目的是：
> 在节点（机器）数量发生变化时，尽可能少地移动数据，保持系统稳定性和负载均衡。


### 二、为什么需要一致性哈希？

#### 普通 Hash（取模）的问题：
当节点数 N 发生变化时，`hash(key) % N` 会导致大量数据重映射，影响系统稳定性。
#### 一致性哈希的优势：
- 节点变化时，只需重分布极少一部分数据（理论上约 1/N）
- 保证哈希环的连续性，数据迁移代价低

### 三、一致性哈希的核心思想
- 将所有节点和数据映射到一个虚拟的**环形哈希空间**（0 到 2^32 - 1）上
- 对 key 和节点都做哈希
- 将 key 顺时针查找落在最近的节点上

### 四、数据分布流程
1. 对每个节点求 hash，放在环上
2. 对每个 key 也求 hash，放在环上
3. 顺时针找到最近的节点，将该 key 存入该节点

#### 示例：
- 节点 A（hash=20），B（50），C（90）
- key "order123"（hash=60） → 顺时针找到 C（90） → 属于 C

### 五、节点变化处理

#### 增加节点：
- 新节点 hash=70，只影响 key ∈ (50, 70] 的部分迁移到新节点

#### 删除节点：
- 删除 C（90），C 管辖的 key 会移交给下一个节点 A（或虚拟节点）


### 六、虚拟节点优化（Virtual Nodes）
为了防止节点过少导致的数据分布不均，引入虚拟节点：
- 每个物理节点对应多个虚拟节点，散布在哈希环上
- 提高负载均衡性，降低数据倾斜风险

### 七、应用场景

|场景|用途|
|---|---|
|分布式缓存|Redis/Memcached 路由|
|负载均衡|请求分发到目标服务器|
|分布式存储|Cassandra、TiKV 等 NoSQL 存储|
|分布式任务|任务分配到调度节点|
|DHT 网络|BitTorrent、Chord 协议等|

### 八、对比普通哈希

|   |   |   |
|---|---|---|
|特性|普通 Hash|一致性哈希|
|数据迁移|多（大部分 key）|少（约 1/N）|
|扩展性|差|好|
|负载均衡|一般|可使用虚拟节点优化|
|场景|本地缓存、单机|分布式环境首选|

### 九、一句话总结

> 一致性哈希通过将节点和 key 映射到哈希环上，配合虚拟节点，实现了高可扩展、低代价的数据分布方式，是构建高可用分布式系统的关键技术之一。