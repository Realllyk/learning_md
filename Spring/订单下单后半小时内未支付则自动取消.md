
å¸¸è§ä¸šåŠ¡åœºæ™¯çš„è®¾è®¡é¢˜ï¼šâ€œ**è®¢å•ä¸‹å•ååŠå°æ—¶å†…æœªæ”¯ä»˜åˆ™è‡ªåŠ¨å–æ¶ˆ**â€ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•å®ç°ä¸€ä¸ª**å»¶è¿Ÿä»»åŠ¡/å®šæ—¶ä»»åŠ¡æœºåˆ¶**ã€‚

è¿™ç±»éœ€æ±‚çš„æ ¸å¿ƒç‚¹åœ¨äºï¼š
- å¦‚ä½•åœ¨ä¸‹å•æ—¶â€œè®°ä½â€ä¸€ä¸ªå»¶è¿Ÿäº‹ä»¶ï¼ˆæ¯”å¦‚åŠå°æ—¶åï¼‰ï¼Œç„¶ååœ¨è¿™ä¸ªæ—¶é—´ç‚¹è‡ªåŠ¨æ‰§è¡Œå–æ¶ˆé€»è¾‘ã€‚


---

## **å®šæ—¶è½®è¯¢ï¼ˆSpringBoot Scheduled å®ç°ï¼‰**

- **å®ç°æ–¹å¼**ï¼šç”¨`Scheduled`ä»»åŠ¡å®šæ—¶æ‰«ææ•°æ®åº“ä¸­çŠ¶æ€ä¸ºâ€œæœªæ”¯ä»˜â€çš„è®¢å•ï¼Œçœ‹æ˜¯å¦å·²è¶…æ—¶ã€‚
- **ä¼˜ç‚¹**ï¼š
    - ç®€å•ç›´æ¥ï¼Œå®¹æ˜“å®ç°ã€‚
- **ç¼ºç‚¹**ï¼š
    - æ‰«åº“ä¼šæœ‰æ•°æ®åº“å‹åŠ›ã€‚
    - å¦‚æœæ‰«æé¢‘ç¹ï¼Œèµ„æºæ¶ˆè€—å¤§ï¼›æ‰«æå¤ªæ…¢åˆå¯èƒ½æ¼å–æ¶ˆè®¢å•ã€‚
    - åœ¨é«˜å¹¶å‘ä¸‹æ€§èƒ½ä¸ç†æƒ³ã€‚


### æ ¸å¿ƒæ€è·¯

1. æ¯ä¸ªæ–°ä¸‹çš„è®¢å•éƒ½ä¼šå­˜å…¥æ•°æ®åº“ï¼Œå¸¦æœ‰ä¸€ä¸ªåˆ›å»ºæ—¶é—´ï¼ˆå¦‚ï¼š`create_time`ï¼‰ã€‚
2. `Scheduled` å®šæ—¶ä»»åŠ¡æ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆæ¯”å¦‚æ¯åˆ†é’Ÿï¼‰æ‰§è¡Œä¸€æ¬¡ï¼Œä»æ•°æ®åº“æŸ¥æ‰¾ï¼šæ‰€æœ‰çŠ¶æ€ä¸ºâ€œæœªæ”¯ä»˜â€ ä¸” å½“å‰æ—¶é—´ - åˆ›å»ºæ—¶é—´ > 30åˆ†é’Ÿ çš„è®¢å•
3. å¯¹è¿™äº›è®¢å•è¿›è¡Œâ€œå–æ¶ˆè®¢å•â€çš„æ“ä½œã€‚


æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆç®€åŒ–ï¼‰


### æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆç®€åŒ–ï¼‰

```sql
CREATE TABLE orders (
  id BIGINT PRIMARY KEY,
  user_id BIGINT,
  status VARCHAR(20), -- 'UNPAID'ã€'PAID'ã€'CANCELLED'
  create_time DATETIME,
  update_time DATETIME
);
```


### ä»£ç ç¤ºä¾‹ï¼ˆåŸºäº Spring Bootï¼‰

#### `Order` å®ä½“ç±»ï¼ˆç®€åŒ–ï¼‰

```java
@Entity
@Table(name = "orders")
public class Order {
    @Id
    private Long id;

    private Long userId;

    private String status; // UNPAID, PAID, CANCELLED

    private LocalDateTime createTime;
    private LocalDateTime updateTime;

    // Getter/Setter ç•¥
}
```


####  `OrderRepository` æ¥å£
```java
public interface OrderRepository extends JpaRepository<Order, Long> {

    @Query("SELECT o FROM Order o WHERE o.status = 'UNPAID' AND o.createTime <= :timeoutTime")
    List<Order> findTimeoutOrders(@Param("timeoutTime") LocalDateTime timeoutTime);

```

#### å®šæ—¶ä»»åŠ¡ç±»
```java
@Component
public class OrderTimeoutScanner {

    @Autowired
    private OrderRepository orderRepository;

    // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    @Scheduled(fixedRate = 60 * 1000)
    public void cancelTimeoutOrders() {
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime timeoutThreshold = now.minusMinutes(30); // è¶…è¿‡30åˆ†é’Ÿ

        List<Order> timeoutOrders = orderRepository.findTimeoutOrders(timeoutThreshold);

        for (Order order : timeoutOrders) {
            order.setStatus("CANCELLED");
            order.setUpdateTime(LocalDateTime.now());
            // å¯ä»¥åŠ ä¸Šå‘é€é€šçŸ¥é€»è¾‘ã€é‡Šæ”¾åº“å­˜ç­‰
        }

        orderRepository.saveAll(timeoutOrders);
        System.out.println("å·²å–æ¶ˆè¶…æ—¶æœªæ”¯ä»˜è®¢å•ï¼š" + timeoutOrders.size());
    }
}

```



#### å¯ç”¨å®šæ—¶ä»»åŠ¡ï¼ˆåŠ æ³¨è§£ï¼‰

```java
@EnableScheduling
@SpringBootApplication
public class OrderApp {
    public static void main(String[] args) {
        SpringApplication.run(OrderApp.class, args);
    }
}

```



---


## **JDK å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆDelayQueueï¼‰**
- **å®ç°æ–¹å¼**ï¼šæŠŠè®¢å•æ”¾è¿›ä¸€ä¸ªJDKè‡ªå¸¦çš„`DelayQueue`ä¸­ï¼Œè®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰ï¼Œåˆ°æ—¶é—´åè§¦å‘å–æ¶ˆã€‚
- **ä¼˜ç‚¹**ï¼š
    - ä¸ä¾èµ–æ•°æ®åº“ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œå»¶è¿Ÿå¤„ç†ä»»åŠ¡æ•ˆç‡é«˜ã€‚
- **ç¼ºç‚¹**ï¼š
    - æ•°æ®éƒ½ä¿å­˜åœ¨å†…å­˜ï¼Œæ— æ³•æŒä¹…åŒ–ã€‚
    - æœåŠ¡å®•æœºä¼šä¸¢æ•°æ®ã€‚
    - å†…å­˜å ç”¨è¾ƒé«˜ã€‚


### ä¸€ã€`DelayQueue` æ˜¯ä»€ä¹ˆï¼Ÿ

- `DelayQueue` æ˜¯ Java æä¾›çš„ä¸€ä¸ª **æ— ç•Œçš„é˜»å¡é˜Ÿåˆ—**ï¼Œé‡Œé¢çš„å…ƒç´ å¿…é¡»å®ç° `Delayed` æ¥å£ã€‚
- æ¯ä¸ªå…ƒç´ éƒ½å¸¦æœ‰ä¸€ä¸ª **â€œå»¶è¿Ÿæ—¶é—´â€**ï¼Œåªæœ‰åœ¨è¿™ä¸ªæ—¶é—´è¿‡åï¼Œè¯¥å…ƒç´ æ‰èƒ½ä»é˜Ÿåˆ—ä¸­è¢«å–å‡ºã€‚
- æ˜¯ **çº¿ç¨‹å®‰å…¨çš„**ï¼ŒåŸºäº **ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆPriorityQueueï¼‰** å®ç°ï¼Œå†…éƒ¨æ’åºæ˜¯æŒ‰è¿‡æœŸæ—¶é—´å‡åºã€‚


### äºŒã€å…³é”®ç»„æˆ

### 1. `DelayQueue<E extends Delayed>`
> å®ƒæ˜¯ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œåªæœ‰â€œåˆ°æ—¶é—´â€çš„å…ƒç´ æ‰èƒ½è¢«å–å‡ºã€‚
### 2. `Delayed` æ¥å£
> ä½ è¦æ”¾è¿›é˜Ÿåˆ—çš„å…ƒç´ ï¼Œå¿…é¡»å®ç°å®ƒï¼Œç”¨æ¥å‘Šè¯‰é˜Ÿåˆ—â€œå¤šä¹…ä¹‹åå¯ä»¥è¢«å–å‡ºâ€ã€‚
```java
public interface Delayed extends Comparable<Delayed> {
    long getDelay(TimeUnit unit);
}
```


### ä¸‰ã€å®Œæ•´ç¤ºä¾‹ï¼šè®¢å•è¶…æ—¶å–æ¶ˆï¼ˆ30åˆ†é’Ÿï¼‰

#### æ­¥éª¤ä¸€ï¼šå®šä¹‰ä¸€ä¸ªå»¶è¿Ÿè®¢å•ä»»åŠ¡ç±»
```java
public class DelayedOrder implements Delayed {

    private Long orderId;
    private long expireTime; // åˆ°æœŸæ—¶é—´æˆ³

    public DelayedOrder(Long orderId, long delayTimeMillis) {
        this.orderId = orderId;
        this.expireTime = System.currentTimeMillis() + delayTimeMillis;
    }

    @Override
    public long getDelay(TimeUnit unit) {
        long diff = expireTime - System.currentTimeMillis();
        return unit.convert(diff, TimeUnit.MILLISECONDS);
    }

    @Override
    public int compareTo(Delayed o) {
        return Long.compare(this.getDelay(TimeUnit.MILLISECONDS), o.getDelay(TimeUnit.MILLISECONDS));
    }

    public Long getOrderId() {
        return orderId;
    }
}
```


#### æ­¥éª¤äºŒï¼šåˆ›å»ºä¸€ä¸ª `DelayQueue`ï¼Œç”¨äºå­˜æ”¾æ‰€æœ‰å¾…å–æ¶ˆçš„è®¢å•
```java
public class DelayQueueManager {

    private static DelayQueue<DelayedOrder> delayQueue = new DelayQueue<>();

    // æ·»åŠ è®¢å•
    public static void addOrder(Long orderId, long delayMillis) {
        DelayedOrder order = new DelayedOrder(orderId, delayMillis);
        delayQueue.put(order);
        System.out.println("è®¢å•å·²åŠ å…¥å»¶è¿Ÿé˜Ÿåˆ—ï¼š" + orderId);
    }

    // å¯åŠ¨æ¶ˆè´¹è€…çº¿ç¨‹
    public static void startOrderTimeoutListener() {
        Thread thread = new Thread(() -> {
            while (true) {
                try {
                    DelayedOrder order = delayQueue.take(); // ä¼šé˜»å¡ç›´åˆ°åˆ°æœŸ
                    System.out.println("è®¢å•è¶…æ—¶ï¼Œæ‰§è¡Œå–æ¶ˆé€»è¾‘ï¼š" + order.getOrderId());
                    // TODO: è°ƒç”¨è®¢å•å–æ¶ˆ service
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
        thread.setDaemon(true); // è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹
        thread.start();
    }
}
```


#### æ­¥éª¤ä¸‰ï¼šå¯åŠ¨ç›‘å¬å™¨ + æ¨¡æ‹Ÿä¸‹å•
```java
@SpringBootApplication
public class OrderApp {

    public static void main(String[] args) {
        SpringApplication.run(OrderApp.class, args);

        // å¯åŠ¨ç›‘å¬å™¨
        DelayQueueManager.startOrderTimeoutListener();

        // æ¨¡æ‹Ÿä¸‹å•ï¼Œ30åˆ†é’Ÿå»¶è¿Ÿï¼ˆ30 * 60 * 1000ï¼‰
        DelayQueueManager.addOrder(1001L, 30 * 60 * 1000);
    }
}

```



`DelayQueue` çš„è¡Œä¸ºæ˜¯è¿™æ ·çš„ï¼š
- **åªæœ‰é˜Ÿé¦–å…ƒç´ çš„å»¶è¿Ÿæ—¶é—´åˆ°è¾¾**ï¼Œå®ƒæ‰ä¼šè¢«å–å‡ºã€‚
- å¦‚æœ**é˜Ÿé¦–å…ƒç´ è¿˜æ²¡åˆ°æ—¶é—´**ï¼Œå³ä½¿é˜Ÿåˆ—ä¸­å…¶ä»–å…ƒç´ å·²ç»è¿‡æœŸï¼Œ`take()` ä¹Ÿä¼š **é˜»å¡ç­‰å¾…** é˜Ÿé¦–çš„é‚£ä¸ªå…ƒç´ åˆ°æœŸã€‚
- ä¹Ÿå°±æ˜¯è¯´ï¼Œ**æ•´ä¸ªé˜Ÿåˆ—çš„å¤„ç†æ˜¯â€œä¸¥æ ¼æŒ‰ç…§è¿‡æœŸæ—¶é—´çš„é¡ºåºâ€æ¥çš„**ã€‚



---



## **æ—¶é—´è½®ç®—æ³•**

- **å®ç°æ–¹å¼**ï¼šæ—¶é—´è½®ç±»ä¼¼ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼Œæ—¶é—´åˆ»åº¦è½®è½¬ï¼Œåˆ°ç‚¹å°±è§¦å‘å¯¹åº”æ§½ä¸­çš„ä»»åŠ¡ã€‚
- **ä¼˜ç‚¹**ï¼š
    - é«˜æ•ˆå®šæ—¶æ‰§è¡Œå¤§é‡ä»»åŠ¡ã€‚
    - ç²¾å‡†æ§åˆ¶è¶…æ—¶ã€‚
- **ç¼ºç‚¹**ï¼š
    - å®ç°å¤æ‚ï¼Œéœ€è¦ä½¿ç”¨æˆç†Ÿçš„æ—¶é—´è½®åº“ã€‚
    - åŒæ ·å­˜åœ¨å†…å­˜å ç”¨é—®é¢˜ã€‚


### ğŸ§  ä¸€ã€ä»€ä¹ˆæ˜¯æ—¶é—´è½®ç®—æ³•ï¼Ÿ

æ—¶é—´è½®ç®—æ³•æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**â€œç¯å½¢æ•°ç»„â€**ï¼Œæ¯ä¸ªæ ¼å­å°±åƒæ˜¯ä¸€ä¸ªâ€œæ—¶é—´æ§½â€ï¼ˆTime Slotï¼‰ã€‚
å¯ä»¥æƒ³è±¡æˆä¸€ä¸ª**é’Ÿè¡¨**ï¼š
- æ¯ä¸ªâ€œæ—¶é—´æ ¼å­â€è¡¨ç¤ºä¸€ä¸ªæ—¶é—´å•ä½ï¼ˆå¦‚ 1 ç§’ï¼‰
- æŒ‡é’ˆæ¯èµ°ä¸€æ­¥ï¼Œè¡¨ç¤ºæ—¶é—´å‰è¿›
- æ¯ä¸ªæ ¼å­é‡Œå¯ä»¥å­˜å¤šä¸ªâ€œå®šæ—¶ä»»åŠ¡â€
- å½“æŒ‡é’ˆèµ°åˆ°æŸä¸ªæ ¼å­ï¼Œå°±æ‰§è¡Œè¯¥æ§½ä¸­çš„æ‰€æœ‰åˆ°æœŸä»»åŠ¡

#### âœ… æ—¶é—´è½®çš„ä¼˜ç‚¹ï¼š
- å†…å­˜å¼€é”€å°ï¼ˆä¸åƒ DelayQueue æŠŠæ‰€æœ‰ä»»åŠ¡æ’åºï¼‰
- æ‰§è¡Œæ•ˆç‡é«˜ï¼ˆæ—¶é—´å¤æ‚åº¦æ¥è¿‘ O(1)ï¼‰
- éå¸¸é€‚åˆå®šæ—¶è½®è¯¢ã€å¿ƒè·³æ£€æµ‹ã€è¿æ¥è¶…æ—¶ã€è®¢å•è¿‡æœŸç­‰å¤§é‡ä»»åŠ¡åœºæ™¯


### ğŸ” äºŒã€é€‚ç”¨åœºæ™¯
- æµ·é‡å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚ 10w ä¸ªè®¢å•å®šæ—¶å–æ¶ˆï¼‰
- å®šæ—¶æ¸…ç†ç¼“å­˜ã€å®šæ—¶æ–­å¼€è¿æ¥
- æ›¿ä»£å®šæ—¶çº¿ç¨‹æ± /DelayQueueï¼Œå¤„ç†è¿‡æœŸä»»åŠ¡


### ä¸‰ã€ç¤ºä¾‹ï¼šç”¨æ—¶é—´è½®å®šæ—¶å–æ¶ˆè®¢å•ä»»åŠ¡
```java
public class SimpleTimeWheel {

    // æ—¶é—´è½®æ§½æ•°
    private static final int SLOT_COUNT = 60;

    // æ¯ä¸ªæ§½ä»£è¡¨ 1 ç§’ï¼Œæ•°ç»„æ¨¡æ‹Ÿç¯å½¢ç»“æ„
    private final List<Set<TimerTask>> wheel = new ArrayList<>(SLOT_COUNT);

    // å½“å‰æŒ‡é’ˆçš„ä½ç½®ï¼ˆç§’ï¼‰
    private int currentSlot = 0;

    public SimpleTimeWheel() {
        for (int i = 0; i < SLOT_COUNT; i++) {
            wheel.add(new HashSet<>());
        }

        // å¯åŠ¨æŒ‡é’ˆçº¿ç¨‹
        new Thread(this::startTick).start();
    }

    // å®šæ—¶å¾ªç¯ç§»åŠ¨æŒ‡é’ˆï¼Œæ¯ç§’å‰è¿›ä¸€æ ¼
    private void startTick() {
        while (true) {
            try {
                Thread.sleep(1000);
                tick();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }

    // æ‰§è¡Œå½“å‰æ§½ä¸­çš„æ‰€æœ‰ä»»åŠ¡
    private void tick() {
        Set<TimerTask> tasks = wheel.get(currentSlot);
        System.out.println("æ—¶é—´è½®æŒ‡é’ˆæŒ‡å‘ï¼š" + currentSlot + "ï¼Œä»»åŠ¡æ•°ï¼š" + tasks.size());

        Iterator<TimerTask> iterator = tasks.iterator();
        while (iterator.hasNext()) {
            TimerTask task = iterator.next();
            if (task.getCycle() == 0) {
                task.run();
                iterator.remove();
            } else {
                task.decrementCycle();
            }
        }

        // æŒ‡é’ˆå‰è¿›ä¸€æ ¼
        currentSlot = (currentSlot + 1) % SLOT_COUNT;
    }

    // æ·»åŠ ä»»åŠ¡ï¼šdelay ç§’åæ‰§è¡Œ
    public void addTask(String name, int delayInSeconds) {
        int totalSlots = delayInSeconds % SLOT_COUNT;
        int cycleNum = delayInSeconds / SLOT_COUNT;

        int slot = (currentSlot + totalSlots) % SLOT_COUNT;
        TimerTask task = new TimerTask(name, cycleNum);

        wheel.get(slot).add(task);
        System.out.println("æ·»åŠ ä»»åŠ¡ï¼š" + name + " åˆ°æ§½ä½ï¼š" + slot + "ï¼Œå»¶è¿Ÿï¼š" + delayInSeconds + " ç§’");
    }

    // ä»»åŠ¡ç±»
    static class TimerTask implements Runnable {
        private final String name;
        private int cycle;

        public TimerTask(String name, int cycle) {
            this.name = name;
            this.cycle = cycle;
        }

        public int getCycle() {
            return cycle;
        }

        public void decrementCycle() {
            this.cycle--;
        }

        @Override
        public void run() {
            System.out.println("ä»»åŠ¡è§¦å‘ï¼š" + name + " æ—¶é—´ï¼š" + LocalTime.now());
        }
    }

    // æµ‹è¯•ä¸»æ–¹æ³•
    public static void main(String[] args) {
        SimpleTimeWheel wheel = new SimpleTimeWheel();
        wheel.addTask("å–æ¶ˆè®¢å•1001", 5);
        wheel.addTask("å–æ¶ˆè®¢å•1002", 10);
        wheel.addTask("å–æ¶ˆè®¢å•1003", 65); // è·¨è½®å›ä»»åŠ¡
    }
}

```



---


## **Redis å®ç°æ–¹æ¡ˆ**

åˆ†ä¸¤ç§æ–¹å¼ï¼š
### æœ‰åºé›†åˆï¼ˆSorted Setï¼‰
- **å®ç°æ–¹å¼**ï¼šæŠŠè®¢å•ä¿¡æ¯ä½œä¸ºvalueï¼Œè¿‡æœŸæ—¶é—´ä½œä¸ºscoreï¼Œå®šæ—¶æŸ¥è¯¢scoreå°äºå½“å‰æ—¶é—´çš„æ•°æ®å¹¶æ‰§è¡Œå–æ¶ˆé€»è¾‘ã€‚
- **ä¼˜ç‚¹**ï¼š
    - æŸ¥è¯¢æ•ˆç‡é«˜ï¼Œæ˜“æ‰©å±•ï¼Œé€‚åˆåˆ†å¸ƒå¼éƒ¨ç½²ã€‚
- **ç¼ºç‚¹**ï¼š
    - éœ€è¦å®šæ—¶è½®è¯¢redisã€‚
    - å®æ—¶æ€§å–å†³äºè½®è¯¢é¢‘ç‡ã€‚
    - é«˜å¹¶å‘æ—¶ä¸€è‡´æ€§å¤„ç†è¦æ±‚é«˜ã€‚

### é”®è¿‡æœŸç›‘å¬ï¼ˆKeyè¿‡æœŸäº‹ä»¶ï¼‰
- **å®ç°æ–¹å¼**ï¼šæ¯ä¸ªè®¢å•è®¾ç½®ä¸€ä¸ª30åˆ†é’Ÿè¿‡æœŸçš„keyï¼Œç›‘å¬å…¶è¿‡æœŸäº‹ä»¶è§¦å‘å–æ¶ˆã€‚
- **ä¼˜ç‚¹**ï¼š
    - å®æ—¶æ€§å¥½ï¼Œä¸éœ€è¦è½®è¯¢ã€‚
    - èµ„æºæ¶ˆè€—ä½ã€‚
- **ç¼ºç‚¹**ï¼š
    - Redisçš„keyè¿‡æœŸç›‘å¬ä¸å¤Ÿå¯é ï¼š
        - ä¸ä¸€å®šæ¯ä¸ªkeyéƒ½èƒ½è§¦å‘è¿‡æœŸäº‹ä»¶ã€‚
        - Redisä¸»ä»åŒæ­¥ã€å®•æœºç­‰éƒ½å¯èƒ½ä¸¢å¤±äº‹ä»¶ã€‚
        - ä¸é€‚åˆæç«¯é«˜å¹¶å‘åœºæ™¯ã€‚


---


## MQæ¶ˆæ¯é˜Ÿåˆ—

### å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆå¦‚ RabbitMQ çš„ `rabbitmq_delayed_message_exchange` æ’ä»¶ï¼‰

#### âœ… åŸç†
å»¶è¿Ÿé˜Ÿåˆ—çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š
> **ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®šä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ï¼›æ¶ˆæ¯ä¸ä¼šç«‹åˆ»è¢«æ¶ˆè´¹ï¼Œè€Œæ˜¯å»¶è¿Ÿä¸€å®šæ—¶é—´åæ‰è¿›å…¥æ­£å¸¸é˜Ÿåˆ—è¢«æ¶ˆè´¹è€…å¤„ç†ã€‚**

RabbitMQ åŸç”Ÿä¸æ”¯æŒç²¾ç¡®çš„å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå› æ­¤é€šå¸¸éœ€è¦å€ŸåŠ©æ’ä»¶ï¼š
> [`rabbitmq_delayed_message_exchange`](https://github.com/rabbitmq/rabbitmq-delayed-message-exchange)

- æ’ä»¶ä¼šå¸®ä½ åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯æ± ï¼Œè¾¾åˆ°æŒ‡å®šæ—¶é—´åå†å°†æ¶ˆæ¯è½¬å‘ç»™çœŸå®æ¶ˆè´¹é˜Ÿåˆ—ã€‚


#### åº”ç”¨ç¤ºä¾‹ï¼ˆè®¢å•å–æ¶ˆåœºæ™¯ï¼‰
1. ç”¨æˆ·ä¸‹å•æˆåŠŸï¼Œå‘é€ä¸€ä¸ªâ€œå»¶è¿Ÿå–æ¶ˆè®¢å•â€çš„æ¶ˆæ¯åˆ°å»¶è¿Ÿäº¤æ¢æœºï¼Œè®¾ç½® `delay = 30åˆ†é’Ÿ`ï¼›
2. æ¶ˆæ¯ä¼šåœ¨ RabbitMQ å†…éƒ¨â€œæ²‰ç¡â€30åˆ†é’Ÿï¼›
3. åˆ°æ—¶é—´åæ¶ˆæ¯æŠ•é€’åˆ°æ™®é€šæ¶ˆè´¹é˜Ÿåˆ—ï¼›
4. æ¶ˆè´¹è€…ç›‘å¬åˆ°æ¶ˆæ¯ï¼Œæ‰§è¡Œå–æ¶ˆè®¢å•ã€‚


### âœ… ä¼˜ç‚¹
- é«˜æ€§èƒ½ï¼Œå¼‚æ­¥éé˜»å¡ï¼›
- æ˜“äºæ‰©å±•ã€æ˜“äºæ¨¡å—åŒ–ï¼›
- æ”¯æŒç²¾ç¡®åˆ°æ¯«ç§’çš„å®šæ—¶è°ƒåº¦ï¼›
- æ¶ˆæ¯æŒä¹…åŒ–ï¼Œä¸å®¹æ˜“ä¸¢å¤±ã€‚


### âŒ ç¼ºç‚¹
- ä¾èµ–æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆRabbitMQ/Kafkaï¼‰ï¼›
- æ’ä»¶é…ç½®å¤æ‚ï¼ˆéœ€è¦å®‰è£…ã€é…ç½®æ’ä»¶ï¼‰ï¼›
- å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜ï¼š**æ¶ˆæ¯åˆ°è¾¾æ¶ˆè´¹é˜Ÿåˆ—äº†ï¼Œä½†æ•°æ®åº“è®¢å•çŠ¶æ€æ²¡æ›´æ–°æ€ä¹ˆåŠï¼Ÿ**
- æ¶ˆæ¯ä¸¢å¤±æˆ–é‡å¤æ¶ˆè´¹ä¹Ÿéœ€è¦å¤„ç†å¹‚ç­‰æ€§ã€‚



### äºŒã€æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLX, Dead Letter Exchangeï¼‰

### âœ… åŸç†
æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLXï¼‰æ˜¯ RabbitMQ çš„ä¸€ç§æœºåˆ¶ï¼Œå½“æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œä¼šè¢«æŠ•é€’åˆ°**æ­»ä¿¡äº¤æ¢æœº**ï¼š
- æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆ`nack` ä¸” `requeue=false`ï¼‰ï¼›
- æ¶ˆæ¯ TTL åˆ°æœŸï¼›
- é˜Ÿåˆ—æ»¡äº†ï¼Œæ— æ³•æŠ•é€’ã€‚

#### å®ç°æµç¨‹å›é¡¾ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š
- **åˆ›å»ºä¸€ä¸ªåŸå§‹é˜Ÿåˆ—ï¼ˆå»¶è¿Ÿé˜Ÿåˆ—ï¼‰A**
    - ä¸ºå®ƒé…ç½®ï¼š
        - TTLï¼ˆæ¶ˆæ¯å­˜æ´»æ—¶é—´ï¼‰
        - ç»‘å®šä¸€ä¸ªæ­»ä¿¡äº¤æ¢æœºï¼ˆDLXï¼‰
- **å°†ä»»åŠ¡ï¼ˆæ¯”å¦‚è®¢å•ä¿¡æ¯ï¼‰æŠ•é€’åˆ°åŸå§‹é˜Ÿåˆ— A**
    - è¿™æ¡æ¶ˆæ¯ä¸ä¼šè¢«æ¶ˆè´¹
    - åªæ˜¯â€œç­‰ç€è¿‡æœŸâ€
- **å½“æ¶ˆæ¯è¿‡æœŸå**
    - å®ƒä¼šè¢« RabbitMQ è‡ªåŠ¨è½¬å‘åˆ° **æ­»ä¿¡äº¤æ¢æœº DLX**
    - DLX ä¼šå†æŠŠæ¶ˆæ¯æŠ•é€’åˆ° **æ­»ä¿¡é˜Ÿåˆ— B**
- **æ¶ˆè´¹è€…ç›‘å¬æ­»ä¿¡é˜Ÿåˆ— B**
    - æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰§è¡Œé€»è¾‘ï¼ˆæ¯”å¦‚å–æ¶ˆè®¢å•ï¼‰

#### ä¼˜ç‚¹
- ä¸éœ€è¦å®‰è£…æ’ä»¶ï¼Œ**åŸç”Ÿæ”¯æŒ**ï¼›
- æ”¯æŒå»¶è¿Ÿ + å¼‚å¸¸æ¶ˆæ¯æ•è·ï¼›
- æ¶æ„æ¸…æ™°ï¼šæ­£å¸¸é˜Ÿåˆ—å’Œè¶…æ—¶é€»è¾‘éš”ç¦»ã€‚

#### ç¼ºç‚¹
- é…ç½®ç›¸å¯¹å¤æ‚ï¼ˆæ¶‰åŠå¤šä¸ªäº¤æ¢æœºã€é˜Ÿåˆ—ã€TTL è®¾ç½®ï¼‰ï¼›
- å»¶è¿Ÿç²’åº¦ä¸å¤Ÿç²¾ç»†ï¼ˆé€šå¸¸ä»¥ç§’ä¸ºå•ä½ï¼‰ï¼›
- æ¶ˆæ¯å¤„ç†é€»è¾‘æ›´ç¹çï¼›
- åŒæ ·å­˜åœ¨æ¶ˆæ¯ä¸€è‡´æ€§ã€å¹‚ç­‰æ€§é—®é¢˜ã€‚



---

## Redisçš„è¿‡æœŸäº‹ä»¶å’ŒMQæ­»ä¿¡é˜Ÿåˆ—çš„åŒºåˆ«



### ä¸€ã€åŸºæœ¬åŸç†å¯¹æ¯”

|ç‰¹æ€§|Redis é”®è¿‡æœŸç›‘å¬|MQ æ­»ä¿¡é˜Ÿåˆ—å»¶è¿Ÿä»»åŠ¡|
|---|---|---|
|å®ç°æœºåˆ¶|Redis è®¾ç½® key è¿‡æœŸæ—¶é—´ TTLï¼Œå¬å¬ key è¢«åˆ é™¤æ—¶çš„è¿‡æœŸäº‹ä»¶|é€šè¿‡æ¶ˆæ¯ TTL + æ­»ä¿¡äº¤æ¢æœºè½¬å‘ï¼Œå®ç°å»¶è¿Ÿå¤„ç†|
|åŸå§‹æ•°æ®|Redis Key|RabbitMQ æ¶ˆæ¯|
|å»¶è¿Ÿæœºåˆ¶|TTL + è¿‡æœŸäº‹ä»¶é€šçŸ¥|TTL + DLX(æ­»ä¿¡äº¤æ¢æœº) + æ­»ä¿¡é˜Ÿåˆ—|

### äºŒã€å®šæ—¶ç²¾åº¦å¯¹æ¯”

|   |   |   |
|---|---|---|
|å¯¹æ¯”é¡¹|Redis|MQ æ­»ä¿¡é˜Ÿåˆ—|
|å»¶è¿Ÿç²¾åº¦|ç§’çº§ï¼ˆæƒ…å†µå¥½å¯è¾¾æ¯«ç§’ï¼‰|æ¯«ç§’çº§ï¼Œå‡†ç¡®|
|æ§åˆ¶ç²’åº¦|åŸºäº keyï¼Œæ¯”è¾ƒç²—ç³™|æ¯æ¡æ¶ˆæ¯å¯å•ç‹¬ TTL|
|æ—¶é—´è¯¯å·®|Redis æ˜¯â€œæƒ°æ€§åˆ é™¤ + å®šæœŸæ‰«æâ€ï¼Œæœ‰è¯¯å·®|RabbitMQ TTL + DLX è§„åˆ™ç¡®åˆ‡|


### ä¸‰ã€å¯é æ€§ & æŒä¹…åŒ–

|   |   |   |
|---|---|---|
|å¯¹æ¯”é¡¹|Redis|MQ æ­»ä¿¡é˜Ÿåˆ—|
|æŒä¹…åŒ–|æœ¬èº«å†…å­˜ï¼Œæ‰‹åŠ¨ RDB/AOF æ—¶æ‰ä¿å­˜|æ¶ˆæ¯æŒä¹…åŒ–ï¼Œæ€§èƒ½ç¨³å®š|
|é«˜å¯ç”¨|Redis éœ€é…ç½®ä¸»ä»ã€å“¨å…µ|RabbitMQ åŸç”Ÿæ”¯æŒ HA é›†ç¾¤|
|å¯é æ€§|ä¸é€‚åˆå…³é”®ä»»åŠ¡|é€‚åˆä¸¥æ ¼å»¶è¿Ÿå¤„ç†åœºæ™¯|

### å››ã€æ€§èƒ½ä¸å‘é‡

|   |   |   |
|---|---|---|
|å¯¹æ¯”é¡¹|Redis|MQ æ­»ä¿¡é˜Ÿåˆ—|
|å‘é‡å‘ä¸Š|æé«˜ï¼Œé€‚åˆé«˜å¹¶å‘|ä¸­çº§ï¼Œå—é™äºæ¶ˆè´¹é€Ÿåº¦|
|å †ç§¯å‹åŠ›|Redis ä¸é€‚åˆå·¨é‡è¿‡æœŸ key|RabbitMQ é€‚åˆå¤§é‡å»¶è¿Ÿæ¶ˆæ¯|
|è®¾ç½®æ–¹ä¾¿|æç®€å•ï¼Œä¸€è¡Œ set key + expire|éœ€é…ç½®å¤šä¸ªé˜Ÿåˆ—/äº¤æ¢æœº/TTL/DLX|

### äº”ã€é€‚ç”¨åœºæ™¯å¯¹æ¯”

|   |   |   |
|---|---|---|
|åœºæ™¯|Redis é”®è¿‡æœŸç›‘å¬|MQ æ­»ä¿¡é˜Ÿåˆ—|
|ä¸­å°å‹é¡¹ç›®ï¼Œä¸é‡è¦ä»»åŠ¡|å¾ˆé€‚åˆ|ä¹Ÿå¯ä»¥ï¼Œä½†è¿‡é‡|
|è®¢å•è´¹ç”¨ã€æ”¯ä»˜è¶…æ—¶æ“ä½œ|å¯ä»¥ï¼Œä½†éœ€é…åˆç‹¬ç«‹æ ¡éªŒ|éå¸¸é€‚åˆï¼Œé«˜å¯é |
|å·¨é‡å»¶è¿Ÿä»»åŠ¡è°ƒåº¦ï¼ˆ10w+ï¼‰|ä¸é€‚åˆï¼Œå®¹æ˜“çˆ† Redis|éå¸¸é€‚åˆï¼Œæ”¯æŒå„ç§ TTL + æŒä¹…|

### æ€»ç»“

> Redis é”®è¿‡æœŸç›‘å¬è¾ƒè½»é‡ã€å®æ—¶ï¼Œé€‚åˆä¸é‡è¦çš„å°å‹å»¶è¿Ÿä»»åŠ¡ï¼›MQ æ­»ä¿¡é˜Ÿåˆ—/å»¶è¿Ÿé˜Ÿåˆ—æ›´é€‚åˆå…³é”®ä¼ä¸šç»æµé€»è¾‘ï¼Œå…·å¤‡æŒä¹…åŒ–ã€å¯é æ€§ã€å¯ç¼©ã€å¯çº¯å¤–éƒ¨å¤„ç†ç­‰ä¼˜åŠ¿ã€‚




---


##  â€œæ”¯ä»˜ç»“æœä¸ä¸€è‡´å¯¼è‡´è¯¯å–æ¶ˆâ€çš„é—®é¢˜

### è§£å†³æ€è·¯æ€»è§ˆï¼š
æˆ‘ä»¬éœ€è¦çš„ä¸æ˜¯â€œé¿å…è¶…æ—¶å–æ¶ˆâ€ï¼Œè€Œæ˜¯â€œ**è®©å–æ¶ˆé€»è¾‘ç¡®è®¤æ˜¯å¦çœŸçš„æœªæ”¯ä»˜**â€ï¼Œç¡®ä¿**ä¸è¯¯æ€å·²ç»å®Œæˆæ”¯ä»˜çš„è®¢å•**ã€‚


### æ ¸å¿ƒæ€è·¯ï¼š**åœ¨å–æ¶ˆè®¢å•ä¹‹å‰ï¼ŒäºŒæ¬¡ç¡®è®¤æ”¯ä»˜çŠ¶æ€**
#### ğŸ” 1. **å–æ¶ˆå‰å…ˆä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€**

- å»¶è¿Ÿé˜Ÿåˆ—è§¦å‘æ—¶ï¼Œä¸ç›´æ¥æŠŠè®¢å•ç½®ä¸ºå–æ¶ˆï¼Œè€Œæ˜¯ï¼š
    - è°ƒç”¨æ”¯ä»˜å¹³å°ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ï¼‰çš„**è®¢å•æŸ¥è¯¢æ¥å£**ï¼Œç¡®è®¤å½“å‰è®¢å•çš„å®é™…æ”¯ä»˜çŠ¶æ€ã€‚
    - å¦‚æœæ”¯ä»˜å·²å®Œæˆ âœ…ï¼š
        - ç«‹å³åŒæ­¥è®¢å•çŠ¶æ€ä¸ºâ€œå·²æ”¯ä»˜â€ï¼Œæµç¨‹æ­£å¸¸èµ°ã€‚
    - å¦‚æœæœªæ”¯ä»˜æˆ–ä¸å­˜åœ¨ âŒï¼š
        - æ­£å¸¸å–æ¶ˆè®¢å•ã€‚

#### ğŸ“© 2. **å¤„ç†æ”¯ä»˜å¼‚æ­¥é€šçŸ¥æ—¶ä¹Ÿè¦åšå¹‚ç­‰æ€§æ£€æŸ¥**
- ç”¨æˆ·å®Œæˆæ”¯ä»˜åï¼Œæ”¯ä»˜å¹³å°ä¸€èˆ¬ä¼šå‘æ¥å¼‚æ­¥é€šçŸ¥ã€‚
- ä½ çš„åç«¯å¤„ç†è¿™ç±»é€šçŸ¥æ—¶ï¼Œéœ€è¦ï¼š
    - å¹‚ç­‰å¤„ç†ï¼ˆåˆ¤æ–­è®¢å•æ˜¯å¦å·²ç»æ›´æ–°è¿‡çŠ¶æ€ï¼‰
    - å³ä½¿è®¢å•å·²ç»è¢«è®¾ç½®æˆå–æ¶ˆï¼Œä¹Ÿè¦**åˆ¤æ–­æ˜¯å¦å¯ä»¥â€œåå–æ¶ˆâ€**ï¼Œæ¯”å¦‚è®¾ç½®ä¸ºâ€œå·²æ”¯ä»˜-ç­‰å¾…äººå·¥å¤„ç†â€


### â›‘3. **è®¢å•çŠ¶æ€è®¾è®¡ï¼šå¼•å…¥â€œæ”¯ä»˜ç¡®è®¤ä¸­â€æˆ–â€œå¾…ç¡®è®¤â€çš„ä¸­é—´æ€**
- å½“ä½ æ¥æ”¶åˆ°æ”¯ä»˜å¼‚æ­¥é€šçŸ¥ä½†çŠ¶æ€ä¸ä¸€è‡´æ—¶ï¼Œå¯ä»¥æŠŠè®¢å•çŠ¶æ€æš‚æ—¶è®¾ç½®ä¸ºâ€œæ”¯ä»˜ç¡®è®¤ä¸­â€ã€‚
- åå°å¯äººå·¥ä»‹å…¥ï¼Œæˆ–å®šæ—¶ä»»åŠ¡å†æ¬¡ç¡®è®¤æ”¯ä»˜çŠ¶æ€ã€‚
